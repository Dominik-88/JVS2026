<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
<meta name="description" content="Profesion√°ln√≠ management syst√©m vod√°rensk√Ωch are√°l≈Ø JVS a.s. s pokroƒçil√Ωmi funkcemi">
<meta name="theme-color" content="#2563eb" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#1e293b" media="(prefers-color-scheme: dark)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Vod√°rny JVS">
<title>Vod√°rensk√© are√°ly ‚Äì Ultra Management System v3.0</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Fuse.js for fuzzy search -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
 --primary: #2563eb;
 --primary-dark: #1e40af;
 --primary-light: #3b82f6;
 --success: #16a34a;
 --success-light: #22c55e;
 --warning: #f59e0b;
 --danger: #dc2626;
 --info: #0ea5e9;
 --gray-50: #f8fafc;
 --gray-100: #f1f5f9;
 --gray-200: #e2e8f0;
 --gray-300: #cbd5e1;
 --gray-400: #94a3b8;
 --gray-500: #64748b;
 --gray-600: #475569;
 --gray-700: #334155;
 --gray-800: #1e293b;
 --gray-900: #0f172a;
 --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
 --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
 --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
 --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
 --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
 --radius: 12px;
 --radius-lg: 16px;
 --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 --safe-area-inset-top: env(safe-area-inset-top);
 --safe-area-inset-bottom: env(safe-area-inset-bottom);
}

/* Dark Mode */
@media (prefers-color-scheme: dark) {
 :root {
 --gray-50: #0f172a;
 --gray-100: #1e293b;
 --gray-200: #334155;
 --gray-300: #475569;
 --gray-400: #64748b;
 --gray-500: #94a3b8;
 --gray-600: #cbd5e1;
 --gray-700: #e2e8f0;
 --gray-800: #f1f5f9;
 --gray-900: #f8fafc;
 }
 
 body {
 background: var(--gray-100);
 color: var(--gray-900);
 }
}

* {
 box-sizing: border-box;
 margin: 0;
 padding: 0;
 -webkit-tap-highlight-color: transparent;
}

body {
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
 background: var(--gray-100);
 color: var(--gray-900);
 overflow: hidden;
 line-height: 1.6;
 -webkit-font-smoothing: antialiased;
 -moz-osx-font-smoothing: grayscale;
 touch-action: pan-x pan-y;
 overscroll-behavior: none;
}

/* ============ TOP BAR ============ */
.top {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 height: calc(64px + var(--safe-area-inset-top));
 padding-top: var(--safe-area-inset-top);
 background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 50%, #3b82f6 100%);
 color: white;
 display: flex;
 align-items: center;
 justify-content: space-between;
 padding-left: max(20px, env(safe-area-inset-left));
 padding-right: max(20px, env(safe-area-inset-right));
 box-shadow: var(--shadow-lg);
 z-index: 2000;
 backdrop-filter: blur(10px);
}

.top-left {
 display: flex;
 align-items: center;
 gap: 16px;
}

.logo {
 font-size: 28px;
 animation: float 3s ease-in-out infinite;
 cursor: pointer;
 user-select: none;
}

@keyframes float {
 0%, 100% { transform: translateY(0); }
 50% { transform: translateY(-5px); }
}

.top-title h1 {
 font-size: 18px;
 font-weight: 800;
 letter-spacing: -0.5px;
 margin-bottom: 2px;
}

.top-title small {
 opacity: 0.9;
 font-size: 11px;
 display: block;
 font-weight: 500;
}

.top-actions {
 display: flex;
 gap: 8px;
 align-items: center;
}

.btn-top {
 padding: 8px 16px;
 background: rgba(255,255,255,0.15);
 border: 1px solid rgba(255,255,255,0.3);
 color: white;
 border-radius: 8px;
 font-size: 13px;
 font-weight: 600;
 cursor: pointer;
 transition: var(--transition);
 display: inline-flex;
 align-items: center;
 gap: 6px;
 backdrop-filter: blur(10px);
 white-space: nowrap;
}

.btn-top:hover {
 background: rgba(255,255,255,0.25);
 transform: translateY(-2px);
 box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-top:active {
 transform: translateY(0) scale(0.95);
}

.sync-indicator {
 width: 10px;
 height: 10px;
 border-radius: 50%;
 background: var(--success);
 animation: pulse 2s infinite;
 box-shadow: 0 0 10px var(--success);
}

.sync-indicator.syncing {
 background: var(--warning);
 animation: spin 1s linear infinite;
}

.sync-indicator.offline {
 background: var(--danger);
 animation: none;
}

@keyframes pulse {
 0%, 100% { opacity: 1; }
 50% { opacity: 0.5; }
}

@keyframes spin {
 from { transform: rotate(0deg); }
 to { transform: rotate(360deg); }
}

/* ============ MAP ============ */
#map {
 position: fixed;
 top: calc(64px + var(--safe-area-inset-top));
 left: 0;
 right: 0;
 bottom: 0;
 z-index: 1;
}

/* Custom marker clusters */
.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
 background: rgba(37, 99, 235, 0.6) !important;
}

.marker-cluster div {
 background: rgba(37, 99, 235, 0.9) !important;
 color: white !important;
 font-weight: 700 !important;
}

/* ============ PANELS ============ */
.panel {
 position: fixed;
 background: var(--gray-50);
 border-radius: var(--radius-lg);
 box-shadow: var(--shadow-xl);
 z-index: 999;
 transition: var(--transition);
 overflow: hidden;
 display: flex;
 flex-direction: column;
 border: 1px solid var(--gray-200);
}

.panel-main {
 top: calc(80px + var(--safe-area-inset-top));
 right: 20px;
 width: min(420px, calc(100vw - 40px));
 max-height: calc(100vh - 100px - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
}

.panel-analytics {
 bottom: calc(20px + var(--safe-area-inset-bottom));
 left: 20px;
 width: min(480px, calc(100vw - 40px));
 max-height: 400px;
 display: none;
}

.panel-analytics.active {
 display: flex;
}

.panel-header {
 background: linear-gradient(135deg, var(--primary), var(--primary-light));
 color: white;
 padding: 16px 20px;
 display: flex;
 justify-content: space-between;
 align-items: center;
 border-bottom: 2px solid rgba(255,255,255,0.2);
}

.panel-header h2 {
 font-size: 16px;
 font-weight: 700;
 display: flex;
 align-items: center;
 gap: 8px;
}

.panel-close {
 background: rgba(255,255,255,0.2);
 border: none;
 color: white;
 width: 32px;
 height: 32px;
 border-radius: 8px;
 cursor: pointer;
 font-size: 18px;
 transition: var(--transition);
 display: flex;
 align-items: center;
 justify-content: center;
}

.panel-close:hover {
 background: rgba(255,255,255,0.3);
 transform: rotate(90deg);
}

.panel-body {
 padding: 20px;
 overflow-y: auto;
 flex: 1;
 -webkit-overflow-scrolling: touch;
}

.panel-body::-webkit-scrollbar {
 width: 8px;
}

.panel-body::-webkit-scrollbar-track {
 background: var(--gray-100);
 border-radius: 4px;
}

.panel-body::-webkit-scrollbar-thumb {
 background: var(--gray-300);
 border-radius: 4px;
 transition: var(--transition);
}

.panel-body::-webkit-scrollbar-thumb:hover {
 background: var(--gray-400);
}

/* ============ SECTIONS ============ */
.section {
 margin-bottom: 24px;
 padding-bottom: 20px;
 border-bottom: 2px solid var(--gray-200);
 animation: slideIn 0.4s ease-out;
}

.section:last-child {
 border: none;
 margin-bottom: 0;
 padding-bottom: 0;
}

@keyframes slideIn {
 from {
 opacity: 0;
 transform: translateY(20px);
 }
 to {
 opacity: 1;
 transform: translateY(0);
 }
}

.section-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 16px;
}

.section h3 {
 font-size: 14px;
 color: var(--primary);
 font-weight: 700;
 display: flex;
 align-items: center;
 gap: 8px;
 text-transform: uppercase;
 letter-spacing: 0.5px;
}

.section-badge {
 background: var(--primary);
 color: white;
 padding: 4px 10px;
 border-radius: 12px;
 font-size: 11px;
 font-weight: 700;
}

/* ============ FORMS ============ */
.form-group {
 margin-bottom: 16px;
}

label {
 font-size: 12px;
 font-weight: 700;
 color: var(--gray-700);
 display: block;
 margin-bottom: 6px;
 text-transform: uppercase;
 letter-spacing: 0.3px;
}

.form-control {
 width: 100%;
 padding: 12px 14px;
 border-radius: 10px;
 border: 2px solid var(--gray-200);
 font-size: 14px;
 font-family: inherit;
 transition: var(--transition);
 background: var(--gray-50);
 color: var(--gray-900);
}

.form-control:focus {
 outline: none;
 border-color: var(--primary);
 box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
 background: white;
}

.form-control:disabled {
 background: var(--gray-100);
 cursor: not-allowed;
 opacity: 0.6;
}

.form-row {
 display: grid;
 grid-template-columns: 1fr 1fr;
 gap: 12px;
}

.input-group {
 position: relative;
}

.input-icon {
 position: absolute;
 right: 12px;
 top: 50%;
 transform: translateY(-50%);
 color: var(--gray-400);
 pointer-events: none;
}

/* ============ BUTTONS ============ */
button, .btn {
 cursor: pointer;
 font-weight: 600;
 transition: var(--transition);
 border: none;
 border-radius: 10px;
 padding: 12px 20px;
 font-size: 14px;
 display: inline-flex;
 align-items: center;
 justify-content: center;
 gap: 8px;
 font-family: inherit;
 position: relative;
 overflow: hidden;
 user-select: none;
}

button:disabled, .btn:disabled {
 opacity: 0.5;
 cursor: not-allowed;
}

button:not(:disabled):hover, .btn:not(:disabled):hover {
 transform: translateY(-2px);
 box-shadow: var(--shadow-md);
}

button:not(:disabled):active, .btn:not(:disabled):active {
 transform: translateY(0) scale(0.95);
}

.btn-primary {
 background: linear-gradient(135deg, var(--primary), var(--primary-light));
 color: white;
}

.btn-primary:hover {
 background: linear-gradient(135deg, var(--primary-dark), var(--primary));
}

.btn-success {
 background: linear-gradient(135deg, var(--success), var(--success-light));
 color: white;
}

.btn-danger {
 background: var(--danger);
 color: white;
}

.btn-danger:hover {
 background: #b91c1c;
}

.btn-secondary {
 background: var(--gray-200);
 color: var(--gray-700);
}

.btn-secondary:hover {
 background: var(--gray-300);
}

.btn-block {
 width: 100%;
 margin-top: 12px;
}

.btn-sm {
 padding: 8px 14px;
 font-size: 12px;
}

.btn-icon {
 width: 40px;
 height: 40px;
 padding: 0;
 border-radius: 50%;
}

/* ============ STATS CARDS ============ */
.stats-grid {
 display: grid;
 grid-template-columns: repeat(2, 1fr);
 gap: 12px;
 margin-bottom: 16px;
}

.stat-card {
 background: linear-gradient(135deg, var(--gray-50), white);
 border: 2px solid var(--gray-200);
 border-radius: var(--radius);
 padding: 16px;
 text-align: center;
 transition: var(--transition);
 cursor: pointer;
 position: relative;
 overflow: hidden;
}

.stat-card::before {
 content: '';
 position: absolute;
 top: 0;
 left: 0;
 right: 0;
 height: 3px;
 background: linear-gradient(90deg, var(--primary), var(--info));
 opacity: 0;
 transition: var(--transition);
}

.stat-card:hover {
 border-color: var(--primary);
 transform: translateY(-4px);
 box-shadow: var(--shadow-md);
}

.stat-card:hover::before {
 opacity: 1;
}

.stat-card.warning {
 background: linear-gradient(135deg, #fef3c7, #fde68a);
 border-color: var(--warning);
}

.stat-card.warning::before {
 background: var(--warning);
}

.stat-card.danger {
 background: linear-gradient(135deg, #fee2e2, #fecaca);
 border-color: var(--danger);
}

.stat-card.danger::before {
 background: var(--danger);
}

.stat-card.success {
 background: linear-gradient(135deg, #d1fae5, #a7f3d0);
 border-color: var(--success);
}

.stat-card.success::before {
 background: var(--success);
}

.stat-icon {
 font-size: 24px;
 margin-bottom: 8px;
 opacity: 0.8;
}

.stat-value {
 font-size: 24px;
 font-weight: 800;
 line-height: 1;
 margin-bottom: 4px;
 color: var(--gray-900);
}

.stat-label {
 font-size: 11px;
 color: var(--gray-600);
 font-weight: 600;
 text-transform: uppercase;
 letter-spacing: 0.5px;
}

.stat-trend {
 font-size: 10px;
 margin-top: 4px;
 font-weight: 600;
}

.stat-trend.up {
 color: var(--success);
}

.stat-trend.down {
 color: var(--danger);
}

/* ============ TABLES ============ */
.table-wrapper {
 max-height: 300px;
 overflow-y: auto;
 border: 2px solid var(--gray-200);
 border-radius: var(--radius);
 background: var(--gray-50);
}

.table {
 width: 100%;
 border-collapse: collapse;
 font-size: 12px;
}

.table thead {
 position: sticky;
 top: 0;
 z-index: 10;
}

.table th {
 background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
 padding: 12px;
 text-align: left;
 font-weight: 700;
 text-transform: uppercase;
 font-size: 11px;
 letter-spacing: 0.5px;
 color: var(--gray-700);
 border-bottom: 2px solid var(--gray-300);
}

.table td {
 padding: 12px;
 border-bottom: 1px solid var(--gray-100);
 color: var(--gray-700);
}

.table tbody tr {
 transition: var(--transition);
}

.table tbody tr:hover {
 background: var(--gray-100);
}

.table tbody tr:last-child td {
 border-bottom: none;
}

.empty-state {
 text-align: center;
 padding: 40px 20px;
 color: var(--gray-500);
}

.empty-state-icon {
 font-size: 48px;
 opacity: 0.3;
 margin-bottom: 12px;
}

.empty-state-text {
 font-size: 14px;
 font-weight: 600;
}

/* ============ TABS ============ */
.tabs {
 display: flex;
 gap: 4px;
 background: var(--gray-100);
 padding: 4px;
 border-radius: 10px;
 margin-bottom: 16px;
}

.tab {
 flex: 1;
 padding: 10px;
 border: none;
 background: transparent;
 border-radius: 8px;
 cursor: pointer;
 font-weight: 600;
 font-size: 13px;
 color: var(--gray-600);
 transition: var(--transition);
}

.tab.active {
 background: white;
 color: var(--primary);
 box-shadow: var(--shadow-sm);
}

.tab-content {
 display: none;
}

.tab-content.active {
 display: block;
 animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
 from { opacity: 0; }
 to { opacity: 1; }
}

/* ============ LEGEND ============ */
.legend {
 position: fixed;
 bottom: calc(20px + var(--safe-area-inset-bottom));
 left: 20px;
 background: var(--gray-50);
 padding: 16px;
 border-radius: var(--radius);
 box-shadow: var(--shadow-lg);
 z-index: 998;
 min-width: 180px;
 border: 2px solid var(--gray-200);
}

.legend-header {
 font-size: 13px;
 font-weight: 700;
 margin-bottom: 12px;
 color: var(--gray-900);
 text-transform: uppercase;
 letter-spacing: 0.5px;
 display: flex;
 align-items: center;
 gap: 8px;
}

.legend-item {
 display: flex;
 align-items: center;
 gap: 10px;
 margin-bottom: 8px;
 font-size: 12px;
 color: var(--gray-700);
 font-weight: 500;
}

.legend-item:last-child {
 margin-bottom: 0;
}

.legend-dot {
 width: 16px;
 height: 16px;
 border-radius: 50%;
 border: 3px solid white;
 box-shadow: 0 2px 6px rgba(0,0,0,0.2);
 flex-shrink: 0;
}

/* ============ TOASTS ============ */
.toast-container {
 position: fixed;
 bottom: calc(80px + var(--safe-area-inset-bottom));
 right: 20px;
 z-index: 3000;
 display: flex;
 flex-direction: column;
 gap: 12px;
 pointer-events: none;
}

.toast {
 background: var(--gray-50);
 padding: 16px 20px;
 border-radius: var(--radius);
 box-shadow: var(--shadow-xl);
 display: flex;
 align-items: center;
 gap: 12px;
 min-width: 300px;
 animation: slideInRight 0.3s ease-out;
 pointer-events: all;
 border-left: 4px solid var(--primary);
}

.toast.success {
 border-left-color: var(--success);
}

.toast.error {
 border-left-color: var(--danger);
}

.toast.warning {
 border-left-color: var(--warning);
}

@keyframes slideInRight {
 from {
 transform: translateX(400px);
 opacity: 0;
 }
 to {
 transform: translateX(0);
 opacity: 1;
 }
}

.toast-icon {
 font-size: 24px;
 flex-shrink: 0;
}

.toast-content {
 flex: 1;
}

.toast-title {
 font-weight: 700;
 font-size: 14px;
 margin-bottom: 2px;
 color: var(--gray-900);
}

.toast-message {
 font-size: 12px;
 color: var(--gray-600);
}

.toast-close {
 background: none;
 border: none;
 color: var(--gray-400);
 cursor: pointer;
 font-size: 18px;
 padding: 0;
 width: 24px;
 height: 24px;
 display: flex;
 align-items: center;
 justify-content: center;
 border-radius: 4px;
 transition: var(--transition);
}

.toast-close:hover {
 background: var(--gray-100);
 color: var(--gray-700);
}

/* ============ MODAL ============ */
.modal-overlay {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(0, 0, 0, 0.6);
 backdrop-filter: blur(8px);
 z-index: 4000;
 display: flex;
 align-items: center;
 justify-content: center;
 padding: 20px;
 animation: fadeIn 0.2s ease-out;
}

.modal {
 background: var(--gray-50);
 border-radius: var(--radius-lg);
 max-width: 600px;
 width: 100%;
 max-height: 90vh;
 overflow: hidden;
 box-shadow: var(--shadow-xl);
 animation: scaleIn 0.3s ease-out;
}

@keyframes scaleIn {
 from {
 transform: scale(0.9);
 opacity: 0;
 }
 to {
 transform: scale(1);
 opacity: 1;
 }
}

.modal-header {
 background: linear-gradient(135deg, var(--primary), var(--primary-light));
 color: white;
 padding: 20px 24px;
 display: flex;
 justify-content: space-between;
 align-items: center;
}

.modal-title {
 font-size: 18px;
 font-weight: 700;
 display: flex;
 align-items: center;
 gap: 10px;
}

.modal-body {
 padding: 24px;
 overflow-y: auto;
 max-height: calc(90vh - 140px);
}

.modal-footer {
 padding: 16px 24px;
 background: var(--gray-100);
 border-top: 2px solid var(--gray-200);
 display: flex;
 justify-content: flex-end;
 gap: 12px;
}

/* ============ CHARTS ============ */
.chart-container {
 position: relative;
 height: 250px;
 margin: 16px 0;
 background: var(--gray-50);
 padding: 16px;
 border-radius: var(--radius);
 border: 2px solid var(--gray-200);
}

/* ============ QUICK ACTIONS ============ */
.quick-actions {
 position: fixed;
 bottom: calc(80px + var(--safe-area-inset-bottom));
 right: 20px;
 display: flex;
 flex-direction: column;
 gap: 12px;
 z-index: 997;
}

.fab {
 width: 56px;
 height: 56px;
 border-radius: 50%;
 background: linear-gradient(135deg, var(--primary), var(--primary-light));
 color: white;
 border: none;
 font-size: 24px;
 cursor: pointer;
 box-shadow: var(--shadow-lg);
 transition: var(--transition);
 display: flex;
 align-items: center;
 justify-content: center;
}

.fab:hover {
 transform: scale(1.1) rotate(10deg);
 box-shadow: var(--shadow-xl);
}

.fab.secondary {
 width: 48px;
 height: 48px;
 font-size: 20px;
 background: var(--gray-50);
 color: var(--primary);
 border: 2px solid var(--primary);
}

/* ============ BADGES ============ */
.badge {
 display: inline-flex;
 align-items: center;
 gap: 4px;
 padding: 4px 10px;
 border-radius: 12px;
 font-size: 11px;
 font-weight: 700;
 text-transform: uppercase;
 letter-spacing: 0.3px;
}

.badge-primary {
 background: var(--primary);
 color: white;
}

.badge-success {
 background: var(--success);
 color: white;
}

.badge-warning {
 background: var(--warning);
 color: white;
}

.badge-danger {
 background: var(--danger);
 color: white;
}

.badge-secondary {
 background: var(--gray-200);
 color: var(--gray-700);
}

/* ============ PROGRESS ============ */
.progress {
 height: 8px;
 background: var(--gray-200);
 border-radius: 4px;
 overflow: hidden;
 margin: 8px 0;
}

.progress-bar {
 height: 100%;
 background: linear-gradient(90deg, var(--primary), var(--primary-light));
 border-radius: 4px;
 transition: width 0.5s ease;
}

/* ============ SEARCH ============ */
.search-box {
 position: relative;
 margin-bottom: 16px;
}

.search-input {
 width: 100%;
 padding: 12px 40px 12px 14px;
 border-radius: 10px;
 border: 2px solid var(--gray-200);
 font-size: 14px;
 transition: var(--transition);
 background: var(--gray-50);
 color: var(--gray-900);
}

.search-input:focus {
 border-color: var(--primary);
 box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
}

.search-icon {
 position: absolute;
 right: 14px;
 top: 50%;
 transform: translateY(-50%);
 color: var(--gray-400);
 font-size: 18px;
}

/* ============ CAMERA BUTTON ============ */
.camera-btn {
 position: relative;
 overflow: hidden;
}

.camera-btn input[type="file"] {
 position: absolute;
 opacity: 0;
 width: 100%;
 height: 100%;
 cursor: pointer;
}

/* ============ PHOTO GALLERY ============ */
.photo-gallery {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
 gap: 8px;
 margin-top: 12px;
}

.photo-item {
 position: relative;
 aspect-ratio: 1;
 border-radius: 8px;
 overflow: hidden;
 cursor: pointer;
 transition: var(--transition);
}

.photo-item:hover {
 transform: scale(1.05);
}

.photo-item img {
 width: 100%;
 height: 100%;
 object-fit: cover;
}

.photo-delete {
 position: absolute;
 top: 4px;
 right: 4px;
 background: rgba(220, 38, 38, 0.9);
 color: white;
 border: none;
 width: 24px;
 height: 24px;
 border-radius: 50%;
 cursor: pointer;
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 14px;
}

/* ============ LOADING ============ */
.spinner {
 border: 3px solid var(--gray-200);
 border-top: 3px solid var(--primary);
 border-radius: 50%;
 width: 20px;
 height: 20px;
 animation: spin 1s linear infinite;
}

@keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
}

.loading-overlay {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(255, 255, 255, 0.9);
 backdrop-filter: blur(5px);
 display: flex;
 align-items: center;
 justify-content: center;
 z-index: 5000;
 flex-direction: column;
 gap: 16px;
}

.loading-spinner {
 border: 6px solid var(--gray-200);
 border-top: 6px solid var(--primary);
 border-radius: 50%;
 width: 60px;
 height: 60px;
 animation: spin 1s linear infinite;
}

.loading-text {
 font-size: 16px;
 font-weight: 600;
 color: var(--gray-700);
}

/* ============ RESPONSIVE ============ */
@media (max-width: 768px) {
 .panel-main {
 left: 10px;
 right: 10px;
 width: auto;
 max-height: calc(100vh - 84px - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
 }
 
 .panel-analytics {
 left: 10px;
 right: 10px;
 width: auto;
 bottom: calc(80px + var(--safe-area-inset-bottom));
 }
 
 .legend {
 left: 10px;
 bottom: calc(10px + var(--safe-area-inset-bottom));
 }
 
 .quick-actions {
 right: 10px;
 bottom: calc(70px + var(--safe-area-inset-bottom));
 }
 
 .stats-grid {
 grid-template-columns: 1fr;
 }
 
 .form-row {
 grid-template-columns: 1fr;
 }
 
 .top-title h1 {
 font-size: 14px;
 }
 
 .top-title small {
 font-size: 10px;
 }
 
 .btn-top {
 padding: 6px 10px;
 font-size: 11px;
 }
 
 .toast {
 min-width: 250px;
 }
}

@media (max-width: 480px) {
 .top {
 height: calc(56px + var(--safe-area-inset-top));
 padding: 0 12px;
 padding-top: var(--safe-area-inset-top);
 }
 
 #map {
 top: calc(56px + var(--safe-area-inset-top));
 }
 
 .panel-main {
 top: calc(66px + var(--safe-area-inset-top));
 }
 
 .logo {
 font-size: 24px;
 }
}

/* ============ UTILITIES ============ */
.hidden {
 display: none !important;
}

.text-center {
 text-align: center;
}

.text-right {
 text-align: right;
}

.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 24px; }
.mb-1 { margin-bottom: 8px; }
.mb-2 { margin-bottom: 16px; }
.mb-3 { margin-bottom: 24px; }

.flex {
 display: flex;
}

.flex-between {
 display: flex;
 justify-content: space-between;
 align-items: center;
}

.gap-1 { gap: 8px; }
.gap-2 { gap: 16px; }

/* ============ DARK MODE TOGGLE ============ */
.theme-toggle {
 width: 40px;
 height: 40px;
 border-radius: 50%;
 background: rgba(255,255,255,0.15);
 border: 1px solid rgba(255,255,255,0.3);
 color: white;
 cursor: pointer;
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 18px;
 transition: var(--transition);
}

.theme-toggle:hover {
 background: rgba(255,255,255,0.25);
 transform: rotate(180deg);
}
</style>
</head>
<body>

<!-- ============ TOP BAR ============ -->
<div class="top">
 <div class="top-left">
 <div class="logo" onclick="location.reload()">üíß</div>
 <div class="top-title">
 <h1>Vod√°rensk√© are√°ly ‚Äì Ultra Management</h1>
 <small>JVS a.s. | Integrated System v3.0 Ultra</small>
 </div>
 </div>
 <div class="top-actions">
 <div class="sync-indicator" id="syncStatus" title="Stav synchronizace"></div>
 <button class="btn-top" onclick="findNearestLocation()">
 üìç <span>Nejbli≈æ≈°√≠</span>
 </button>
 <button class="btn-top" onclick="toggleAnalytics()">
 üìä <span>Analytics</span>
 </button>
 <button class="btn-top" onclick="exportData()">
 üíæ <span>Export</span>
 </button>
 <button class="theme-toggle" onclick="toggleDarkMode()" title="P≈ôepnout t√©ma">
 üåô
 </button>
 </div>
</div>

<!-- ============ MAP ============ -->
<div id="map"></div>

<!-- ============ MAIN PANEL ============ -->
<div class="panel panel-main">
 <div class="panel-header">
 <h2>üéØ Ovl√°dac√≠ panel</h2>
 </div>
 <div class="panel-body">
 
 <!-- Tabs -->
 <div class="tabs">
 <button class="tab active" onclick="switchTab('filters')">üîç Filtry</button>
 <button class="tab" onclick="switchTab('actions')">‚ö° Akce</button>
 <button class="tab" onclick="switchTab('log')">üìã Evidence</button>
 <button class="tab" onclick="switchTab('photos')">üì∏ Foto</button>
 </div>
 
 <!-- Tab: Filters -->
 <div id="tab-filters" class="tab-content active">
 
 <!-- Statistics -->
 <div class="section">
 <div class="section-header">
 <h3>üìä Statistiky</h3>
 <span class="section-badge" id="filteredCount">0</span>
 </div>
 <div class="stats-grid">
 <div class="stat-card" onclick="filterByStatus('all')">
 <div class="stat-icon">üè¢</div>
 <div class="stat-value" id="statObjects">0</div>
 <div class="stat-label">Objekt≈Ø</div>
 </div>
 <div class="stat-card">
 <div class="stat-icon">üìê</div>
 <div class="stat-value" id="statArea">0</div>
 <div class="stat-label">V√Ωmƒõra m¬≤</div>
 </div>
 <div class="stat-card">
 <div class="stat-icon">üîó</div>
 <div class="stat-value" id="statFence">0</div>
 <div class="stat-label">Oplocen√≠ bm</div>
 </div>
 <div class="stat-card success" onclick="filterByStatus('dobr√Ω')">
 <div class="stat-icon">‚úÖ</div>
 <div class="stat-value" id="statGood">0</div>
 <div class="stat-label">Dobr√Ω stav</div>
 </div>
 <div class="stat-card warning" onclick="filterByStatus('rizikov√Ω')">
 <div class="stat-icon">‚ö†Ô∏è</div>
 <div class="stat-value" id="statRisk">0</div>
 <div class="stat-label">Rizikov√©</div>
 </div>
 <div class="stat-card danger" onclick="filterByStatus('havarijn√≠')">
 <div class="stat-icon">üö®</div>
 <div class="stat-value" id="statCritical">0</div>
 <div class="stat-label">Havarijn√≠</div>
 </div>
 </div>
 </div>
 
 <!-- Filters -->
 <div class="section">
 <h3>üîç Filtrace dat</h3>
 <div class="search-box">
 <input
 type="text"
 id="filterName"
 class="search-input"
 placeholder="üîç Hledat podle n√°zvu..."
 oninput="applyFilters()">
 <span class="search-icon">üîç</span>
 </div>
 
 <div class="form-group">
 <label>Okres</label>
 <select id="filterOkres" class="form-control" onchange="applyFilters()">
 <option value="all">üåç V≈°echny okresy</option>
 </select>
 </div>
 
 <div class="form-row">
 <div class="form-group">
 <label>Kategorie</label>
 <select id="filterKategorie" class="form-control" onchange="applyFilters()">
 <option value="all">V≈°echny</option>
 <option value="I.">Kategorie I.</option>
 <option value="II.">Kategorie II.</option>
 <option value="Bez">Bez kategorie</option>
 </select>
 </div>
 <div class="form-group">
 <label>Stav</label>
 <select id="filterStatus" class="form-control" onchange="applyFilters()">
 <option value="all">V≈°echny</option>
 <option value="dobr√Ω">‚úÖ Dobr√Ω</option>
 <option value="rizikov√Ω">‚ö†Ô∏è Rizikov√Ω</option>
 <option value="havarijn√≠">üö® Havarijn√≠</option>
 </select>
 </div>
 </div>
 
 <button class="btn btn-secondary btn-block" onclick="resetFilters()">
 üîÑ Resetovat filtry
 </button>
 </div>
 
 <!-- Finance Overview -->
 <div class="section">
 <div class="section-header">
 <h3>üí∞ Finance</h3>
 <button class="btn-sm btn-primary" onclick="switchTab('actions')">+ P≈ôidat</button>
 </div>
 <div class="stat-card" style="grid-column: 1/-1;">
 <div class="stat-icon">üíµ</div>
 <div class="stat-value" id="totalProfit" style="color: var(--success);">0 Kƒç</div>
 <div class="stat-label">Celkov√Ω zisk</div>
 <div class="stat-trend up" id="profitTrend">+0 Kƒç tento mƒõs√≠c</div>
 </div>
 </div>
 
 </div>
 
 <!-- Tab: Actions -->
 <div id="tab-actions" class="tab-content">
 
 <!-- Work Log -->
 <div class="section">
 <h3>üë∑ Z√°znam pr√°ce</h3>
 
 <div class="form-group">
 <label>Zamƒõstnanec</label>
 <input
 type="text"
 id="empName"
 class="form-control"
 placeholder="Jm√©no zamƒõstnance">
 </div>
 
 <div class="form-group">
 <label>Objekt</label>
 <select id="empObject" class="form-control">
 <option value="">-- Vyberte objekt --</option>
 </select>
 </div>
 
 <div class="form-row">
 <div class="form-group">
 <label>Odpracov√°no (h)</label>
 <input
 type="number"
 id="empHours"
 class="form-control"
 value="8"
 min="0"
 step="0.5">
 </div>
 <div class="form-group">
 <label>Posek√°no (m¬≤)</label>
 <input
 type="number"
 id="empArea"
 class="form-control"
 value="1500"
 min="0">
 </div>
 </div>
 
 <div class="form-row">
 <div class="form-group">
 <label>Ujeto (km)</label>
 <input
 type="number"
 id="empKm"
 class="form-control"
 value="150"
 min="0">
 </div>
 <div class="form-group">
 <label>Datum</label>
 <input
 type="date"
 id="empDate"
 class="form-control"
 value="">
 </div>
 </div>
 
 <div class="form-group">
 <label>Pozn√°mka</label>
 <input
 type="text"
 id="empNote"
 class="form-control"
 placeholder="Voliteln√° pozn√°mka...">
 </div>
 
 <button class="btn btn-success btn-block" onclick="saveWorkLog()">
 üíæ Ulo≈æit z√°znam pr√°ce
 </button>
 </div>
 
 <!-- Finance Entry -->
 <div class="section">
 <h3>üí∞ Finanƒçn√≠ z√°znam</h3>
 
 <div class="form-row">
 <div class="form-group">
 <label>P≈ô√≠jem (Kƒç)</label>
 <input
 type="number"
 id="finIncome"
 class="form-control"
 value="5000"
 min="0"
 oninput="updateFinancePreview()">
 </div>
 <div class="form-group">
 <label>N√°klad (Kƒç)</label>
 <input
 type="number"
 id="finExpense"
 class="form-control"
 value="1000"
 min="0"
 oninput="updateFinancePreview()">
 </div>
 </div>
 
 <div class="stat-card" style="margin: 16px 0;">
 <div class="stat-icon">üìä</div>
 <div class="stat-value" id="finPreview" style="color: var(--success);">4 000 Kƒç</div>
 <div class="stat-label">Vypoƒçten√Ω zisk</div>
 </div>
 
 <div class="form-group">
 <label>Popis transakce</label>
 <input
 type="text"
 id="finDescription"
 class="form-control"
 placeholder="Popis...">
 </div>
 
 <div class="form-group">
 <label>Datum</label>
 <input
 type="date"
 id="finDate"
 class="form-control"
 value="">
 </div>
 
 <button class="btn btn-primary btn-block" onclick="saveFinance()">
 üí∞ Ulo≈æit finanƒçn√≠ z√°znam
 </button>
 </div>
 
 <!-- Quick Actions -->
 <div class="section">
 <h3>‚ö° Rychl√© akce</h3>
 <button class="btn btn-secondary btn-block" onclick="bulkUpdateStatus()">
 üîÑ Hromadn√° aktualizace stavu
 </button>
 <button class="btn btn-secondary btn-block" onclick="generatePDFReport()">
 üìÑ Generovat PDF report
 </button>
 <button class="btn btn-secondary btn-block" onclick="scheduleInspection()">
 üìÖ Napl√°novat inspekci
 </button>
 </div>
 
 </div>
 
 <!-- Tab: Log -->
 <div id="tab-log" class="tab-content">
 <div class="section">
 <div class="section-header">
 <h3>üìã Historie z√°znam≈Ø</h3>
 <button class="btn-sm btn-danger" onclick="clearLog()">
 üóëÔ∏è Smazat
 </button>
 </div>
 
 <div class="table-wrapper">
 <table class="table">
 <thead>
 <tr>
 <th>ƒåas</th>
 <th>Typ</th>
 <th>Z√°znam</th>
 </tr>
 </thead>
 <tbody id="logTableBody">
 </tbody>
 </table>
 <div id="emptyLog" class="empty-state hidden">
 <div class="empty-state-icon">üìã</div>
 <div class="empty-state-text">Zat√≠m ≈æ√°dn√© z√°znamy</div>
 </div>
 </div>
 </div>
 </div>
 
 <!-- Tab: Photos -->
 <div id="tab-photos" class="tab-content">
 <div class="section">
 <h3>üì∏ Fotodokumentace</h3>
 
 <div class="form-group">
 <label>Vyberte objekt</label>
 <select id="photoObject" class="form-control" onchange="loadPhotos()">
 <option value="">-- Vyberte objekt --</option>
 </select>
 </div>
 
 <button class="btn btn-primary btn-block camera-btn">
 üì∑ P≈ôidat fotografii
 <input type="file" accept="image/*" capture="environment" onchange="addPhoto(event)">
 </button>
 
 <div class="photo-gallery" id="photoGallery">
 <!-- Photos will be loaded here -->
 </div>
 
 <div id="emptyPhotos" class="empty-state">
 <div class="empty-state-icon">üì∏</div>
 <div class="empty-state-text">Zat√≠m ≈æ√°dn√© fotografie</div>
 </div>
 </div>
 </div>
 
 </div>
</div>

<!-- ============ ANALYTICS PANEL ============ -->
<div class="panel panel-analytics" id="analyticsPanel">
 <div class="panel-header">
 <h2>üìä Analytick√Ω dashboard</h2>
 <button class="panel-close" onclick="toggleAnalytics()">√ó</button>
 </div>
 <div class="panel-body">
 <div class="chart-container">
 <canvas id="statusChart"></canvas>
 </div>
 </div>
</div>

<!-- ============ LEGEND ============ -->
<div class="legend">
 <div class="legend-header">
 üé® Legenda stav≈Ø
 </div>
 <div class="legend-item">
 <div class="legend-dot" style="background: #16a34a;"></div>
 <span>Dobr√Ω stav</span>
 </div>
 <div class="legend-item">
 <div class="legend-dot" style="background: #f59e0b;"></div>
 <span>Rizikov√Ω stav</span>
 </div>
 <div class="legend-item">
 <div class="legend-dot" style="background: #dc2626;"></div>
 <span>Havarijn√≠ stav</span>
 </div>
</div>

<!-- ============ QUICK ACTIONS FAB ============ -->
<div class="quick-actions">
 <button class="fab" onclick="openQuickAdd()" title="Rychl√Ω z√°znam">
 ‚ûï
 </button>
</div>

<!-- ============ TOAST CONTAINER ============ -->
<div class="toast-container" id="toastContainer"></div>

<!-- ============ SCRIPTS ============ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
 crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
// ============ CONFIGURATION ============
const CONFIG = {
 appVersion: '3.0.0',
 appName: 'Vod√°rensk√© are√°ly Ultra Management System',
 defaultMapCenter: [49.15, 14.35],
 defaultMapZoom: 9,
 maxLogEntries: 100,
 autoSaveInterval: 30000,
 offlineSupport: true,
 enableHaptics: true,
 enableGeolocation: true,
 maxPhotoSize: 5 * 1024 * 1024 // 5MB
};

// ============ DATA ============
const LOCATIONS_DATA = [
 {o:"PI",n:"VDJ Amerika II",k:"I.",bm:293,v:3303,lat:49.305131,lon:14.166126,s:"dobr√Ω"},
 {o:"ST",n:"VDJ Drahonice",k:"I.",bm:376,v:5953,lat:49.202902,lon:14.063713,s:"rizikov√Ω"},
 {o:"ST",n:"VDJ Vod≈àany",k:"I.",bm:252,v:1594,lat:49.147778,lon:14.175278,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Hlavatce",k:"Bez",bm:424,v:7968,lat:49.063584,lon:14.267751,s:"dobr√Ω"},
 {o:"PT",n:"VDJ ≈†ibeniƒçn√≠ vrch I",k:"I.",bm:245,v:1835,lat:49.013333,lon:13.994444,s:"rizikov√Ω"},
 {o:"PT",n:"√öV Husinecka p≈ôehrada",k:"Bez",bm:703,v:4908,lat:49.058889,lon:13.994722,s:"dobr√Ω"},
 {o:"PT",n:"VDJ ≈†ibeniƒçn√≠ vrch II",k:"I.",bm:340,v:3206,lat:49.026710,lon:13.994001,s:"dobr√Ω"},
 {o:"PI",n:"VDJ Z√°lu≈æany",k:"Bez",bm:299,v:2350,lat:49.316389,lon:14.096111,s:"rizikov√Ω"},
 {o:"PT",n:"VDJ Pt√°ƒçn√≠k",k:"II.",bm:239,v:1070,lat:49.091111,lon:13.948056,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Zdoba",k:"II.",bm:225,v:15523,lat:49.212422,lon:14.338095,s:"havarijn√≠"},
 {o:"CK",n:"VDJ Domoradice",k:"I.",bm:450,v:4148,lat:48.812778,lon:14.273056,s:"dobr√Ω"},
 {o:"CK",n:"VDJ Horn√≠ Br√°na",k:"I.",bm:187,v:1665,lat:48.807970,lon:14.329352,s:"dobr√Ω"},
 {o:"CK",n:"VDJ Net≈ôebice",k:"I.",bm:136,v:877,lat:48.856389,lon:14.318611,s:"rizikov√Ω"},
 {o:"CK",n:"VDJ Ple≈°ivec",k:"I.",bm:119,v:975,lat:48.823056,lon:14.165278,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Doudleby",k:"II.",bm:79,v:413,lat:48.991944,lon:14.505556,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Jankov",k:"I.",bm:106,v:784,lat:49.033566,lon:14.492817,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Hos√≠n II",k:"I.",bm:399,v:4173,lat:49.016111,lon:14.452778,s:"rizikov√Ω"},
 {o:"CB",n:"VDJ Chlum",k:"II.",bm:63,v:535,lat:49.091944,lon:14.534167,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Chot√Ωƒçany",k:"II.",bm:338,v:4775,lat:49.133611,lon:14.498889,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Rudolfov III",k:"I.",bm:174,v:1868,lat:48.988889,lon:14.595833,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Rimov - Vesce",k:"I.",bm:99,v:662,lat:48.842778,lon:14.525,s:"rizikov√Ω"},
 {o:"CB",n:"VDJ Hosin",k:"II.",bm:125,v:809,lat:49.013889,lon:14.450278,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Vƒçeln√°",k:"II.",bm:476,v:8660,lat:48.966389,lon:14.454722,s:"dobr√Ω"},
 {o:"CB",n:"VDJ H√∫ry",k:"I.",bm:0,v:395,lat:49.058611,lon:14.481944,s:"havarijn√≠"},
 {o:"CB",n:"VDJ Chlumec",k:"II.",bm:110,v:811,lat:49.054167,lon:14.488889,s:"dobr√Ω"},
 {o:"CB",n:"VDJ Ole≈°n√≠k",k:"I.",bm:117,v:380,lat:49.056944,lon:14.498611,s:"dobr√Ω"},
 {o:"CB",n:"ƒåS Bukovec",k:"I.",bm:300,v:4943,lat:48.949167,lon:14.480833,s:"rizikov√Ω"},
 {o:"CB",n:"VDJ He≈ôman",k:"II.",bm:119,v:982,lat:48.991667,lon:14.535,s:"dobr√Ω"},
 {o:"CB",n:"ƒåS Vidov u ≈ôeky",k:"II.",bm:212,v:2501,lat:48.950833,lon:14.479722,s:"dobr√Ω"},
 {o:"CB",n:"Vrt Vidov",k:"II.",bm:164,v:470,lat:48.951111,lon:14.480556,s:"dobr√Ω"},
 {o:"CB",n:"√öV Plav",k:"I.",bm:1413,v:74777,lat:49.006111,lon:14.452778,s:"dobr√Ω"},
 {o:"TA",n:"VDJ ƒåekanice",k:"I.",bm:450,v:6344,lat:49.422197,lon:14.689896,s:"rizikov√Ω"},
 {o:"TA",n:"VDJ Svat√° Anna",k:"I.",bm:264,v:4192,lat:49.401133,lon:14.69864,s:"dobr√Ω"},
 {o:"TA",n:"VDJ Bezdƒõƒç√≠n",k:"I.",bm:169,v:1996,lat:49.381667,lon:14.700556,s:"dobr√Ω"},
 {o:"TA",n:"VDJ Milevsko",k:"I.",bm:129,v:823,lat:49.452521,lon:14.344102,s:"dobr√Ω"},
 {o:"TA",n:"VDJ Hodu≈°√≠n",k:"II.",bm:205,v:1708,lat:49.42967,lon:14.474214,s:"dobr√Ω"},
 {o:"TA",n:"VDJ V≈°echov",k:"I.",bm:199,v:1574,lat:49.430159,lon:14.623205,s:"rizikov√Ω"},
 {o:"TA",n:"VDJ Zlukov",k:"II.",bm:184,v:1520,lat:49.196289,lon:14.736382,s:"dobr√Ω"},
 {o:"TA",n:"√öV T√°bor",k:"II.",bm:350,v:12262,lat:49.422872,lon:14.666426,s:"dobr√Ω"},
 {o:"TA",n:"ƒåS Sudomƒõ≈ôice",k:"I.",bm:220,v:2508,lat:49.368611,lon:14.720278,s:"dobr√Ω"},
 {o:"TA",n:"Provozn√≠ Vodojem T√°bor",k:"II.",bm:155,v:1853,lat:49.413889,lon:14.659167,s:"dobr√Ω"}
];

// ============ STATE ============
let map, markerCluster, heatLayer;
let filteredData = [...LOCATIONS_DATA];
let statusChart = null;
let userLocation = null;
let appState = {
 totalProfit: 0,
 logs: [],
 photos: {}, // {objectName: [photoDataUrls]}
 syncStatus: 'online',
 darkMode: false,
 filters: {
 name: '',
 okres: 'all',
 kategorie: 'all',
 status: 'all'
 }
};

// ============ INITIALIZATION ============
function init() {
 console.log(`${CONFIG.appName} v${CONFIG.appVersion} - Inicializace...`);
 
 // Load saved state
 loadState();
 
 // Initialize map
 initMap();
 
 // Populate dropdowns
 populateDropdowns();
 
 // Set default dates
 setDefaultDates();
 
 // Render data
 renderMarkers();
 updateStatistics();
 renderLog();
 
 // Setup auto-save
 if (CONFIG.offlineSupport) {
 setInterval(saveState, CONFIG.autoSaveInterval);
 }
 
 // Check online status
 updateOnlineStatus();
 window.addEventListener('online', updateOnlineStatus);
 window.addEventListener('offline', updateOnlineStatus);
 
 // Request geolocation
 if (CONFIG.enableGeolocation) {
 requestGeolocation();
 }
 
 // Apply dark mode if saved
 if (appState.darkMode) {
 document.body.classList.add('dark-mode');
 }
 
 // Setup swipe gestures
 setupSwipeGestures();
 
 showToast('success', 'Syst√©m p≈ôipraven', 'Aplikace byla √∫spƒõ≈°nƒõ naƒçtena');
}

// ============ MAP FUNCTIONS ============
function initMap() {
 map = L.map('map').setView(CONFIG.defaultMapCenter, CONFIG.defaultMapZoom);
 
 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
 attribution: '¬© OpenStreetMap contributors',
 maxZoom: 19
 }).addTo(map);
 
 markerCluster = L.markerClusterGroup({
 spiderfyOnMaxZoom: true,
 showCoverageOnHover: false,
 zoomToBoundsOnClick: true
 });
 
 map.addLayer(markerCluster);
 
 // Add heatmap layer
 heatLayer = L.heatLayer([], {
 radius: 25,
 blur: 15,
 maxZoom: 17,
 gradient: {
 0.0: '#16a34a',
 0.5: '#f59e0b',
 1.0: '#dc2626'
 }
 });
}

function renderMarkers() {
 markerCluster.clearLayers();
 
 const heatData = [];
 
 filteredData.forEach(location => {
 const color = getStatusColor(location.s);
 const marker = L.circleMarker([location.lat, location.lon], {
 radius: 10,
 fillColor: color,
 color: '#fff',
 weight: 3,
 opacity: 1,
 fillOpacity: 0.8
 });
 
 marker.bindPopup(createPopupContent(location), {
 maxWidth: 300,
 className: 'custom-popup'
 });
 
 marker.on('click', () => {
 highlightLocation(location);
 triggerHaptic();
 });
 
 // Long press for context menu
 let pressTimer;
 marker.on('mousedown touchstart', () => {
 pressTimer = setTimeout(() => {
 showContextMenu(location);
 triggerHaptic('medium');
 }, 500);
 });
 
 marker.on('mouseup touchend', () => {
 clearTimeout(pressTimer);
 });
 
 markerCluster.addLayer(marker);
 
 // Add to heatmap data
 heatData.push([location.lat, location.lon, location.s === 'havarijn√≠' ? 1 : (location.s === 'rizikov√Ω' ? 0.5 : 0.2)]);
 });
 
 // Update heatmap
 heatLayer.setLatLngs(heatData);
}

function getStatusColor(status) {
 const colors = {
 'dobr√Ω': '#16a34a',
 'rizikov√Ω': '#f59e0b',
 'havarijn√≠': '#dc2626'
 };
 return colors[status] || '#64748b';
}

function createPopupContent(loc) {
 const statusEmoji = {
 'dobr√Ω': '‚úÖ',
 'rizikov√Ω': '‚ö†Ô∏è',
 'havarijn√≠': 'üö®'
 };
 
 const photoCount = (appState.photos[loc.n] || []).length;
 
 return `
 <div style="font-family: system-ui; min-width: 250px; padding: 8px;">
 <div style="background: linear-gradient(135deg, #2563eb, #3b82f6); color: white; padding: 16px; margin: -16px -16px 16px; border-radius: 12px 12px 0 0;">
 <strong style="font-size: 16px; display: block; margin-bottom: 4px;">${loc.n}</strong>
 <span style="font-size: 12px; opacity: 0.9;">${loc.o} ‚Ä¢ ${loc.k}</span>
 </div>
 <div style="padding: 0 4px;">
 <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
 <span style="color: #64748b; font-weight: 600;">Stav:</span>
 <strong style="color: ${getStatusColor(loc.s)};">${statusEmoji[loc.s]} ${loc.s.toUpperCase()}</strong>
 </div>
 <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
 <span style="color: #64748b; font-weight: 600;">V√Ωmƒõra:</span>
 <strong>${loc.v.toLocaleString()} m¬≤</strong>
 </div>
 <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
 <span style="color: #64748b; font-weight: 600;">Oplocen√≠:</span>
 <strong>${loc.bm.toLocaleString()} bm</strong>
 </div>
 <div style="display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px;">
 <span style="color: #64748b; font-weight: 600;">Fotografie:</span>
 <strong>üì∏ ${photoCount}</strong>
 </div>
 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
 <a href="https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lon}"
 target="_blank"
 style="display: block; text-align: center; padding: 10px; background: #2563eb; color: white; text-decoration: none; border-radius: 8px; font-size: 12px; font-weight: 600;">
 üß≠ Navigace
 </a>
 <button onclick="addWorkForLocation('${loc.n}')"
 style="padding: 10px; background: #16a34a; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
 ‚ûï Pr√°ce
 </button>
 </div>
 <button onclick="viewPhotos('${loc.n}')"
 style="width: 100%; margin-top: 8px; padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">
 üì∏ Zobrazit fotografie (${photoCount})
 </button>
 </div>
 </div>
 `;
}

function highlightLocation(location) {
 console.log('Zv√Ωraznƒõna lokace:', location.n);
 triggerHaptic();
}

function addWorkForLocation(locationName) {
 switchTab('actions');
 document.getElementById('empObject').value = locationName;
 showToast('info', 'P≈ôipraveno', `Objekt "${locationName}" byl vybr√°n`);
 triggerHaptic();
}

function viewPhotos(locationName) {
 switchTab('photos');
 document.getElementById('photoObject').value = locationName;
 loadPhotos();
 triggerHaptic();
}

// ============ GEOLOCATION ============
function requestGeolocation() {
 if ('geolocation' in navigator) {
 navigator.geolocation.getCurrentPosition(
 (position) => {
 userLocation = {
 lat: position.coords.latitude,
 lon: position.coords.longitude
 };
 console.log('Geolokace z√≠sk√°na:', userLocation);
 
 // Add user marker
 L.marker([userLocation.lat, userLocation.lon], {
 icon: L.divIcon({
 className: 'user-location-marker',
 html: '<div style="background: #2563eb; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
 iconSize: [20, 20]
 })
 }).addTo(map).bindPopup('üìç Va≈°e poloha');
 },
 (error) => {
 console.warn('Geolokace nedostupn√°:', error);
 }
 );
 }
}

function findNearestLocation() {
 if (!userLocation) {
 showToast('warning', 'Geolokace nedostupn√°', 'Povolte p≈ô√≠stup k poloze');
 return;
 }
 
 let nearest = null;
 let minDistance = Infinity;
 
 LOCATIONS_DATA.forEach(loc => {
 const distance = calculateDistance(
 userLocation.lat, userLocation.lon,
 loc.lat, loc.lon
 );
 
 if (distance < minDistance) {
 minDistance = distance;
 nearest = loc;
 }
 });
 
 if (nearest) {
 map.setView([nearest.lat, nearest.lon], 15);
 showToast('success', 'Nejbli≈æ≈°√≠ objekt', `${nearest.n} (${minDistance.toFixed(1)} km)`);
 triggerHaptic();
 }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
 const R = 6371; // Earth radius in km
 const dLat = (lat2 - lat1) * Math.PI / 180;
 const dLon = (lon2 - lon1) * Math.PI / 180;
 const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
 Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
 Math.sin(dLon/2) * Math.sin(dLon/2);
 const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
 return R * c;
}

// ============ FILTER FUNCTIONS ============
function applyFilters() {
 const nameFilter = document.getElementById('filterName').value.toLowerCase();
 const okresFilter = document.getElementById('filterOkres').value;
 const kategorieFilter = document.getElementById('filterKategorie').value;
 const statusFilter = document.getElementById('filterStatus').value;
 
 appState.filters = {
 name: nameFilter,
 okres: okresFilter,
 kategorie: kategorieFilter,
 status: statusFilter
 };
 
 filteredData = LOCATIONS_DATA.filter(loc => {
 const matchName = !nameFilter || loc.n.toLowerCase().includes(nameFilter);
 const matchOkres = okresFilter === 'all' || loc.o === okresFilter;
 const matchKategorie = kategorieFilter === 'all' || loc.k === kategorieFilter;
 const matchStatus = statusFilter === 'all' || loc.s === statusFilter;
 
 return matchName && matchOkres && matchKategorie && matchStatus;
 });
 
 renderMarkers();
 updateStatistics();
}

function filterByStatus(status) {
 document.getElementById('filterStatus').value = status;
 applyFilters();
 showToast('info', 'Filtr aplikov√°n', `Zobrazeny objekty: ${status}`);
 triggerHaptic();
}

function resetFilters() {
 document.getElementById('filterName').value = '';
 document.getElementById('filterOkres').value = 'all';
 document.getElementById('filterKategorie').value = 'all';
 document.getElementById('filterStatus').value = 'all';
 applyFilters();
 showToast('success', 'Filtry resetov√°ny', 'Zobrazeny v≈°echny objekty');
 triggerHaptic();
}

// ============ STATISTICS ============
function updateStatistics() {
 const totalArea = filteredData.reduce((sum, loc) => sum + loc.v, 0);
 const totalFence = filteredData.reduce((sum, loc) => sum + loc.bm, 0);
 const goodStatus = filteredData.filter(loc => loc.s === 'dobr√Ω').length;
 const riskStatus = filteredData.filter(loc => loc.s === 'rizikov√Ω').length;
 const criticalStatus = filteredData.filter(loc => loc.s === 'havarijn√≠').length;
 
 document.getElementById('filteredCount').textContent = filteredData.length;
 document.getElementById('statObjects').textContent = filteredData.length;
 document.getElementById('statArea').textContent = totalArea.toLocaleString();
 document.getElementById('statFence').textContent = totalFence.toLocaleString();
 document.getElementById('statGood').textContent = goodStatus;
 document.getElementById('statRisk').textContent = riskStatus;
 document.getElementById('statCritical').textContent = criticalStatus;
 document.getElementById('totalProfit').textContent = appState.totalProfit.toLocaleString() + ' Kƒç';
 
 updateProfitTrend();
}

function updateProfitTrend() {
 const currentMonth = new Date().getMonth();
 const monthLogs = appState.logs.filter(log => {
 if (log.type === 'finance') {
 const logDate = new Date(log.timestamp);
 return logDate.getMonth() === currentMonth;
 }
 return false;
 });
 
 const monthlyProfit = monthLogs.reduce((sum, log) => {
 return sum + (log.data.profit || 0);
 }, 0);
 
 const trendEl = document.getElementById('profitTrend');
 trendEl.textContent = `${monthlyProfit >= 0 ? '+' : ''}${monthlyProfit.toLocaleString()} Kƒç tento mƒõs√≠c`;
 trendEl.className = monthlyProfit >= 0 ? 'stat-trend up' : 'stat-trend down';
}

// ============ WORK LOG ============
function saveWorkLog() {
 const empName = document.getElementById('empName').value.trim();
 const empObject = document.getElementById('empObject').value;
 const empHours = parseFloat(document.getElementById('empHours').value) || 0;
 const empArea = parseFloat(document.getElementById('empArea').value) || 0;
 const empKm = parseFloat(document.getElementById('empKm').value) || 0;
 const empDate = document.getElementById('empDate').value;
 const empNote = document.getElementById('empNote').value.trim();
 
 if (!empName) {
 showToast('error', 'Chyba', 'Vypl≈àte jm√©no zamƒõstnance');
 triggerHaptic('error');
 return;
 }
 
 if (!empObject) {
 showToast('error', 'Chyba', 'Vyberte objekt');
 triggerHaptic('error');
 return;
 }
 
 if (empHours <= 0) {
 showToast('error', 'Chyba', 'Zadejte platn√Ω poƒçet hodin');
 triggerHaptic('error');
 return;
 }
 
 const logEntry = {
 id: Date.now(),
 type: 'work',
 timestamp: empDate || new Date().toISOString(),
 data: {
 employee: empName,
 object: empObject,
 hours: empHours,
 area: empArea,
 km: empKm,
 note: empNote
 }
 };
 
 addLog(logEntry);
 showToast('success', 'Ulo≈æeno', `Z√°znam pr√°ce pro ${empName} byl ulo≈æen`);
 triggerHaptic('success');
 
 // Reset form
 document.getElementById('empName').value = '';
 document.getElementById('empArea').value = '1500';
 document.getElementById('empKm').value = '150';
 document.getElementById('empNote').value = '';
}

// ============ FINANCE ============
function updateFinancePreview() {
 const income = parseFloat(document.getElementById('finIncome').value) || 0;
 const expense = parseFloat(document.getElementById('finExpense').value) || 0;
 const profit = income - expense;
 
 const previewEl = document.getElementById('finPreview');
 previewEl.textContent = profit.toLocaleString() + ' Kƒç';
 previewEl.style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
}

function saveFinance() {
 const income = parseFloat(document.getElementById('finIncome').value) || 0;
 const expense = parseFloat(document.getElementById('finExpense').value) || 0;
 const description = document.getElementById('finDescription').value.trim();
 const finDate = document.getElementById('finDate').value;
 
 if (income === 0 && expense === 0) {
 showToast('error', 'Chyba', 'Zadejte p≈ô√≠jem nebo n√°klad');
 triggerHaptic('error');
 return;
 }
 
 const profit = income - expense;
 appState.totalProfit += profit;
 
 const logEntry = {
 id: Date.now(),
 type: 'finance',
 timestamp: finDate || new Date().toISOString(),
 data: {
 income: income,
 expense: expense,
 profit: profit,
 description: description
 }
 };
 
 addLog(logEntry);
 updateStatistics();
 showToast('success', 'Ulo≈æeno', `Finanƒçn√≠ z√°znam byl p≈ôid√°n: ${profit >= 0 ? '+' : ''}${profit.toLocaleString()} Kƒç`);
 triggerHaptic('success');
 
 // Reset form
 document.getElementById('finIncome').value = '5000';
 document.getElementById('finExpense').value = '1000';
 document.getElementById('finDescription').value = '';
 updateFinancePreview();
}

// ============ LOG MANAGEMENT ============
function addLog(entry) {
 appState.logs.unshift(entry);
 
 if (appState.logs.length > CONFIG.maxLogEntries) {
 appState.logs = appState.logs.slice(0, CONFIG.maxLogEntries);
 }
 
 renderLog();
 saveState();
}

function renderLog() {
 const tbody = document.getElementById('logTableBody');
 const emptyEl = document.getElementById('emptyLog');
 
 if (appState.logs.length === 0) {
 tbody.innerHTML = '';
 emptyEl.classList.remove('hidden');
 return;
 }
 
 emptyEl.classList.add('hidden');
 
 tbody.innerHTML = appState.logs.map(log => {
 const date = new Date(log.timestamp);
 const timeStr = date.toLocaleString('cs-CZ', {
 day: '2-digit',
 month: '2-digit',
 year: 'numeric',
 hour: '2-digit',
 minute: '2-digit'
 });
 
 let content = '';
 let typeIcon = '';
 
 if (log.type === 'work') {
 typeIcon = 'üë∑';
 content = `${log.data.employee} ‚Ä¢ ${log.data.object} ‚Ä¢ ${log.data.hours}h, ${log.data.area}m¬≤, ${log.data.km}km`;
 } else if (log.type === 'finance') {
 typeIcon = 'üí∞';
 const profitClass = log.data.profit >= 0 ? 'success' : 'danger';
 content = `P≈ô√≠jem ${log.data.income.toLocaleString()}Kƒç, N√°klad ${log.data.expense.toLocaleString()}Kƒç ‚Üí <span style="color: var(--${profitClass}); font-weight: 700;">${log.data.profit >= 0 ? '+' : ''}${log.data.profit.toLocaleString()}Kƒç</span>`;
 }
 
 return `
 <tr>
 <td style="white-space: nowrap; font-weight: 600;">${timeStr}</td>
 <td style="text-align: center;">${typeIcon}</td>
 <td>${content}</td>
 </tr>
 `;
 }).join('');
}

function clearLog() {
 if (!confirm('Opravdu chcete smazat v≈°echny z√°znamy?')) {
 return;
 }
 
 appState.logs = [];
 renderLog();
 saveState();
 showToast('success', 'Vymaz√°no', 'V≈°echny z√°znamy byly odstranƒõny');
 triggerHaptic();
}

// ============ PHOTO MANAGEMENT ============
function addPhoto(event) {
 const file = event.target.files[0];
 const objectName = document.getElementById('photoObject').value;
 
 if (!objectName) {
 showToast('error', 'Chyba', 'Nejprve vyberte objekt');
 triggerHaptic('error');
 return;
 }
 
 if (!file) return;
 
 if (file.size > CONFIG.maxPhotoSize) {
 showToast('error', 'Chyba', 'Fotografie je p≈ô√≠li≈° velk√° (max 5MB)');
 triggerHaptic('error');
 return;
 }
 
 const reader = new FileReader();
 reader.onload = (e) => {
 if (!appState.photos[objectName]) {
 appState.photos[objectName] = [];
 }
 
 appState.photos[objectName].push({
 dataUrl: e.target.result,
 timestamp: new Date().toISOString()
 });
 
 saveState();
 loadPhotos();
 showToast('success', 'P≈ôid√°no', 'Fotografie byla ulo≈æena');
 triggerHaptic('success');
 };
 
 reader.readAsDataURL(file);
}

function loadPhotos() {
 const objectName = document.getElementById('photoObject').value;
 const gallery = document.getElementById('photoGallery');
 const emptyEl = document.getElementById('emptyPhotos');
 
 if (!objectName || !appState.photos[objectName] || appState.photos[objectName].length === 0) {
 gallery.innerHTML = '';
 emptyEl.style.display = 'block';
 return;
 }
 
 emptyEl.style.display = 'none';
 
 gallery.innerHTML = appState.photos[objectName].map((photo, index) => `
 <div class="photo-item">
 <img src="${photo.dataUrl}" alt="Foto ${index + 1}" onclick="viewPhotoFullscreen('${objectName}', ${index})">
 <button class="photo-delete" onclick="deletePhoto('${objectName}', ${index})">√ó</button>
 </div>
 `).join('');
}

function deletePhoto(objectName, index) {
 if (!confirm('Opravdu chcete smazat tuto fotografii?')) {
 return;
 }
 
 appState.photos[objectName].splice(index, 1);
 
 if (appState.photos[objectName].length === 0) {
 delete appState.photos[objectName];
 }
 
 saveState();
 loadPhotos();
 showToast('success', 'Smaz√°no', 'Fotografie byla odstranƒõna');
 triggerHaptic();
}

function viewPhotoFullscreen(objectName, index) {
 const photo = appState.photos[objectName][index];
 const modal = document.createElement('div');
 modal.className = 'modal-overlay';
 modal.innerHTML = `
 <div class="modal">
 <div class="modal-header">
 <div class="modal-title">üì∏ Fotografie</div>
 <button class="panel-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
 </div>
 <div class="modal-body">
 <img src="${photo.dataUrl}" style="width: 100%; border-radius: 8px;">
 <p style="margin-top: 12px; text-align: center; color: var(--gray-600); font-size: 12px;">
 ${new Date(photo.timestamp).toLocaleString('cs-CZ')}
 </p>
 </div>
 </div>
 `;
 
 document.body.appendChild(modal);
 triggerHaptic();
}

// ============ TABS ============
function switchTab(tabName) {
 document.querySelectorAll('.tab').forEach(tab => {
 tab.classList.remove('active');
 });
 event.target.classList.add('active');
 
 document.querySelectorAll('.tab-content').forEach(content => {
 content.classList.remove('active');
 });
 document.getElementById(`tab-${tabName}`).classList.add('active');
 
 triggerHaptic();
}

// ============ ANALYTICS ============
function toggleAnalytics() {
 const panel = document.getElementById('analyticsPanel');
 panel.classList.toggle('active');
 
 if (panel.classList.contains('active')) {
 renderStatusChart();
 }
 
 triggerHaptic();
}

function renderStatusChart() {
 const ctx = document.getElementById('statusChart');
 
 if (statusChart) {
 statusChart.destroy();
 }
 
 const statusCounts = {
 'Dobr√Ω': filteredData.filter(loc => loc.s === 'dobr√Ω').length,
 'Rizikov√Ω': filteredData.filter(loc => loc.s === 'rizikov√Ω').length,
 'Havarijn√≠': filteredData.filter(loc => loc.s === 'havarijn√≠').length
 };
 
 statusChart = new Chart(ctx, {
 type: 'doughnut',
 data: {
 labels: Object.keys(statusCounts),
 datasets: [{
 data: Object.values(statusCounts),
 backgroundColor: ['#16a34a', '#f59e0b', '#dc2626'],
 borderWidth: 3,
 borderColor: '#fff'
 }]
 },
 options: {
 responsive: true,
 maintainAspectRatio: false,
 plugins: {
 legend: {
 position: 'bottom',
 labels: {
 font: {
 size: 12,
 weight: 600
 },
 padding: 15
 }
 },
 title: {
 display: true,
 text: 'Distribuce stav≈Ø objekt≈Ø',
 font: {
 size: 14,
 weight: 700
 }
 }
 }
 }
 });
}

// ============ EXPORT ============
function exportData() {
 const exportTypes = [
 { label: 'CSV - Seznam objekt≈Ø', value: 'csv-objects' },
 { label: 'CSV - Evidence pr√°ce', value: 'csv-work' },
 { label: 'CSV - Finance', value: 'csv-finance' },
 { label: 'JSON - Kompletn√≠ data', value: 'json-all' },
 { label: 'PDF - Profesion√°ln√≠ report', value: 'pdf-report' }
 ];
 
 const choice = prompt(
 'Vyberte typ exportu:\n' +
 exportTypes.map((t, i) => `${i + 1}. ${t.label}`).join('\n') +
 '\n\nZadejte ƒç√≠slo:'
 );
 
 const index = parseInt(choice) - 1;
 if (index >= 0 && index < exportTypes.length) {
 const type = exportTypes[index].value;
 performExport(type);
 }
}

function performExport(type) {
 let content, filename, mimeType;
 
 if (type === 'csv-objects') {
 content = generateObjectsCSV();
 filename = `objekty_${getDateString()}.csv`;
 mimeType = 'text/csv';
 } else if (type === 'csv-work') {
 content = generateWorkCSV();
 filename = `prace_${getDateString()}.csv`;
 mimeType = 'text/csv';
 } else if (type === 'csv-finance') {
 content = generateFinanceCSV();
 filename = `finance_${getDateString()}.csv`;
 mimeType = 'text/csv';
 } else if (type === 'json-all') {
 content = JSON.stringify({
 exported: new Date().toISOString(),
 version: CONFIG.appVersion,
 locations: LOCATIONS_DATA,
 state: appState
 }, null, 2);
 filename = `export_${getDateString()}.json`;
 mimeType = 'application/json';
 } else if (type === 'pdf-report') {
 generatePDFReport();
 return;
 }
 
 downloadFile(content, filename, mimeType);
 showToast('success', 'Export dokonƒçen', `Soubor ${filename} byl sta≈æen`);
 triggerHaptic('success');
}

function generateObjectsCSV() {
 const headers = ['Nazev', 'Okres', 'Kategorie', 'Stav', 'Oploceni_bm', 'Vymera_m2', 'GPS_Lat', 'GPS_Lon'];
 const rows = filteredData.map(loc => [
 loc.n, loc.o, loc.k, loc.s, loc.bm, loc.v, loc.lat, loc.lon
 ]);
 return [headers, ...rows].map(row => row.join(';')).join('\n');
}

function generateWorkCSV() {
 const workLogs = appState.logs.filter(log => log.type === 'work');
 const headers = ['Datum', 'Zamestnanec', 'Objekt', 'Hodiny', 'Plocha_m2', 'Km', 'Poznamka'];
 const rows = workLogs.map(log => [
 new Date(log.timestamp).toLocaleString('cs-CZ'),
 log.data.employee,
 log.data.object,
 log.data.hours,
 log.data.area,
 log.data.km,
 log.data.note || ''
 ]);
 return [headers, ...rows].map(row => row.join(';')).join('\n');
}

function generateFinanceCSV() {
 const financeLogs = appState.logs.filter(log => log.type === 'finance');
 const headers = ['Datum', 'Prijem_Kc', 'Naklad_Kc', 'Zisk_Kc', 'Popis'];
 const rows = financeLogs.map(log => [
 new Date(log.timestamp).toLocaleString('cs-CZ'),
 log.data.income,
 log.data.expense,
 log.data.profit,
 log.data.description || ''
 ]);
 return [headers, ...rows].map(row => row.join(';')).join('\n');
}

function generatePDFReport() {
 showToast('info', 'Generov√°n√≠ PDF', 'Report se p≈ôipravuje...');
 
 // This would require jsPDF library implementation
 // For now, show placeholder
 setTimeout(() => {
 showToast('warning', 'Funkce v p≈ô√≠pravƒõ', 'PDF export bude brzy dostupn√Ω');
 }, 1000);
}

function downloadFile(content, filename, mimeType) {
 const blob = new Blob([content], { type: mimeType });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = filename;
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
 URL.revokeObjectURL(url);
}

function getDateString() {
 return new Date().toISOString().split('T')[0];
}

// ============ QUICK ACTIONS ============
function openQuickAdd() {
 switchTab('actions');
 showToast('info', 'Rychl√Ω z√°znam', 'Formul√°≈ô byl otev≈ôen');
 triggerHaptic();
}

function bulkUpdateStatus() {
 showToast('info', 'Funkce v p≈ô√≠pravƒõ', 'Hromadn√° aktualizace bude brzy dostupn√°');
}

function scheduleInspection() {
 showToast('info', 'Funkce v p≈ô√≠pravƒõ', 'Pl√°nov√°n√≠ inspekc√≠ bude brzy dostupn√©');
}

function showContextMenu(location) {
 const menu = document.createElement('div');
 menu.className = 'modal-overlay';
 menu.innerHTML = `
 <div class="modal">
 <div class="modal-header">
 <div class="modal-title">‚öôÔ∏è ${location.n}</div>
 <button class="panel-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
 </div>
 <div class="modal-body">
 <button class="btn btn-primary btn-block" onclick="addWorkForLocation('${location.n}'); this.closest('.modal-overlay').remove();">
 ‚ûï P≈ôidat pr√°ci
 </button>
 <button class="btn btn-secondary btn-block" onclick="viewPhotos('${location.n}'); this.closest('.modal-overlay').remove();">
 üì∏ Zobrazit fotografie
 </button>
 <button class="btn btn-secondary btn-block" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lon}', '_blank'); this.closest('.modal-overlay').remove();">
 üß≠ Navigovat
 </button>
 </div>
 </div>
 `;
 
 document.body.appendChild(menu);
}

// ============ DARK MODE ============
function toggleDarkMode() {
 appState.darkMode = !appState.darkMode;
 document.body.classList.toggle('dark-mode');
 saveState();
 
 const icon = document.querySelector('.theme-toggle');
 icon.textContent = appState.darkMode ? '‚òÄÔ∏è' : 'üåô';
 
 showToast('success', 'T√©ma zmƒõnƒõno', appState.darkMode ? 'Tmav√Ω re≈æim aktivov√°n' : 'Svƒõtl√Ω re≈æim aktivov√°n');
 triggerHaptic();
}

// ============ HAPTIC FEEDBACK ============
function triggerHaptic(type = 'light') {
 if (!CONFIG.enableHaptics) return;
 
 if ('vibrate' in navigator) {
 const patterns = {
 'light': [10],
 'medium': [20],
 'heavy': [30],
 'success': [10, 50, 10],
 'error': [50, 100, 50]
 };
 
 navigator.vibrate(patterns[type] || patterns.light);
 }
}

// ============ SWIPE GESTURES ============
function setupSwipeGestures() {
 let touchStartX = 0;
 let touchEndX = 0;
 
 document.addEventListener('touchstart', e => {
 touchStartX = e.changedTouches[0].screenX;
 });
 
 document.addEventListener('touchend', e => {
 touchEndX = e.changedTouches[0].screenX;
 handleSwipe();
 });
 
 function handleSwipe() {
 const swipeThreshold = 100;
 const diff = touchEndX - touchStartX;
 
 if (Math.abs(diff) > swipeThreshold) {
 if (diff > 0) {
 // Swipe right - previous tab
 console.log('Swipe right detected');
 } else {
 // Swipe left - next tab
 console.log('Swipe left detected');
 }
 }
 }
}

// ============ TOAST NOTIFICATIONS ============
function showToast(type, title, message) {
 const container = document.getElementById('toastContainer');
 
 const icons = {
 'success': '‚úÖ',
 'error': '‚ùå',
 'warning': '‚ö†Ô∏è',
 'info': '‚ÑπÔ∏è'
 };
 
 const toast = document.createElement('div');
 toast.className = `toast ${type}`;
 toast.innerHTML = `
 <div class="toast-icon">${icons[type]}</div>
 <div class="toast-content">
 <div class="toast-title">${title}</div>
 <div class="toast-message">${message}</div>
 </div>
 <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
 `;
 
 container.appendChild(toast);
 
 setTimeout(() => {
 toast.remove();
 }, 5000);
}

// ============ STATE MANAGEMENT ============
function saveState() {
 try {
 localStorage.setItem('appState', JSON.stringify(appState));
 updateOnlineStatus();
 } catch (e) {
 console.error('Chyba p≈ôi ukl√°d√°n√≠ stavu:', e);
 }
}

function loadState() {
 try {
 const saved = localStorage.getItem('appState');
 if (saved) {
 const loaded = JSON.parse(saved);
 appState = { ...appState, ...loaded };
 }
 } catch (e) {
 console.error('Chyba p≈ôi naƒç√≠t√°n√≠ stavu:', e);
 }
}

// ============ UTILITIES ============
function populateDropdowns() {
 // Okresy
 const okresy = [...new Set(LOCATIONS_DATA.map(loc => loc.o))].sort();
 const okresSelect = document.getElementById('filterOkres');
 okresy.forEach(okres => {
 const option = document.createElement('option');
 option.value = okres;
 option.textContent = okres;
 okresSelect.appendChild(option);
 });
 
 // Objects for work log
 const empSelect = document.getElementById('empObject');
 const photoSelect = document.getElementById('photoObject');
 const sortedNames = [...LOCATIONS_DATA].sort((a, b) => a.n.localeCompare(b.n));
 
 sortedNames.forEach(loc => {
 const option1 = document.createElement('option');
 option1.value = loc.n;
 option1.textContent = loc.n;
 empSelect.appendChild(option1);
 
 const option2 = document.createElement('option');
 option2.value = loc.n;
 option2.textContent = loc.n;
 photoSelect.appendChild(option2);
 });
}

function setDefaultDates() {
 const today = new Date().toISOString().split('T')[0];
 document.getElementById('empDate').value = today;
 document.getElementById('finDate').value = today;
}

function updateOnlineStatus() {
 const indicator = document.getElementById('syncStatus');
 if (navigator.onLine) {
 indicator.className = 'sync-indicator';
 appState.syncStatus = 'online';
 } else {
 indicator.className = 'sync-indicator offline';
 appState.syncStatus = 'offline';
 }
}

// ============ START APPLICATION ============
document.addEventListener('DOMContentLoaded', init);

// Service Worker registration for PWA
if ('serviceWorker' in navigator && CONFIG.offlineSupport) {
 window.addEventListener('load', () => {
 navigator.serviceWorker.register('/sw.js')
 .then(reg => console.log('Service Worker registrov√°n'))
 .catch(err => console.log('Service Worker registrace selhala:', err));
 });
}
</script>

</body>
</html>
